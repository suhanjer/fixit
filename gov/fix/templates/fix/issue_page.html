{% extends 'fix/layout.html' %}
{% load static %}

{% block head %}
    <title>{{ issue_data.title }}</title>
    <script src="https://maps.api.2gis.ru/2.0/loader.js"></script>
{% endblock %}

{% block body %}
    <img src="{{ issue_data.image.url }}" alt="image" style="max-height:300px">
    <h1>{{ issue_data.title }}</h1>
    {% if issue_data.author == request.user %}
        <input id="remove" type="button" value="Remove">
    {% endif %}
    <p>{{ issue_data.description }}</p>

    <!-- Map section -->
    <input id="create" type="button" value="Show on map">
    <input id="update" type="button" value="Update" hidden>
    <p>Pin coordinates: <div id="location">{{ issue_data.latitude }}, {{ issue_data.longitude }}</div></p>
    <div id="mapBlock"></div>
{% endblock %}

{% block scriptend %}
    <script>
        var createButton = document.getElementById('create');
        var locationInfo = document.getElementById('location');
        var updateButton = document.getElementById('update');
        var removeButton = document.getElementById('remove');
        var lat, lng;

        createButton.onclick = function() {
            var container = document.createElement('div'),
                mapBlock = document.getElementById('mapBlock');

            container.id = 'map';
            container.style.width = '100%';
            container.style.height = '400px';
            mapBlock.appendChild(container);

            DG.then(function(){
                var map, marker;
                map = DG.map('map', {
                    center: [{{ issue_data.latitude }}, {{ issue_data.longitude }}],
                    zoom: 16
                });
                if ('{{ user }}' == '{{ issue_data.author }}') {
                    marker = DG.marker([{{ issue_data.latitude }}, {{ issue_data.longitude }}], {
                        draggable: true
                    }).addTo(map);

                    marker.on('drag', function(e) {
                        updateButton.removeAttribute('hidden');
                        lat = e.target._latlng.lat;
                        lng = e.target._latlng.lng;

                        locationInfo.innerHTML = lat + ', ' + lng;
                    });
                } else {
                    DG.marker([{{ issue_data.latitude }}, {{ issue_data.longitude }}]).addTo(map).bindPopup('{{ issue_data.title }}');
                }
            });
        }
        updateButton.onclick = function() {
            issue_id = {{ issue_data.id }};
            fetch(`/update_coordinates/${issue_id}?latitude=${lat}&longitude=${lng}`)
            .then(response => response.text())
            .then(data => {
                if (data == "success") {
                    alert('Pin position has been updated');
                    updateButton.setAttribute("hidden", "");
                }
            })
            .catch(error => {
                console.log('Erroru:', error);
            });
        }
        removeButton.onclick = function() {
            issue_id = {{ issue_data.id }};
            fetch(`/remove/${issue_id}`)
            .then(response => response.text())
            .then(data => {
                if (data == "success") {
                    alert('Issue has been removed');
                    location.href = "http://127.0.0.1:8000/";
                }
                else {
                    alert("you no longer can remove this issue");
                }
            })
            .catch(error => {
                console.log('Erroru:', error);
            });
        }
    </script>    
{% endblock %}